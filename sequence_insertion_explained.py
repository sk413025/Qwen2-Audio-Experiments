"""
æ·±å…¥è§£é‡‹ï¼šåºåˆ—ç´šæ’å…¥ï¼ˆæ›¿æ› <|AUDIO|> tokenï¼‰æ©Ÿåˆ¶

é€™å€‹ç¨‹å¼è©³ç´°å±•ç¤º Qwen2-Audio å¦‚ä½•åœ¨åºåˆ—å±¤é¢æ’å…¥éŸ³é » embeddingsï¼Œ
è€Œä¸æ˜¯åœ¨ç‰¹å¾µå±¤é¢é€²è¡Œæ‹¼æ¥æˆ–ç›¸åŠ ã€‚
"""

import numpy as np
import torch
from transformers import AutoProcessor

def print_header(title, width=100):
    """æ‰“å°æ¨™é¡Œ"""
    print("\n" + "=" * width)
    print(f"  {title}")
    print("=" * width)

def print_subheader(title, width=100):
    """æ‰“å°å­æ¨™é¡Œ"""
    print(f"\n{'â”€' * width}")
    print(f"  {title}")
    print(f"{'â”€' * width}")

def visualize_sequence_insertion():
    """å¯è¦–åŒ–åºåˆ—æ’å…¥çš„å®Œæ•´éç¨‹"""

    print_header("åºåˆ—ç´šæ’å…¥ (Sequence-Level Insertion) æ·±å…¥è§£æ")

    print("""
é€™å€‹æ¦‚å¿µæ˜¯ç†è§£ Qwen2-Audio å¤šæ¨¡æ…‹èåˆçš„é—œéµï¼
è®“æˆ‘å€‘å¾é ­é–‹å§‹ï¼Œç”¨å…·é«”çš„æ•¸å€¼å’Œåœ–ç¤ºä¾†èªªæ˜ã€‚
    """)

    # ============================================================================
    # ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è§£å•é¡Œ - ç‚ºä»€éº¼éœ€è¦èåˆï¼Ÿ
    # ============================================================================
    print_header("ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è§£å•é¡Œ - å…©ç¨®å®Œå…¨ä¸åŒçš„æ¨¡æ…‹")

    print("""
æˆ‘å€‘æœ‰å…©ç¨®å®Œå…¨ä¸åŒçš„è¼¸å…¥ï¼š

1ï¸âƒ£  æ–‡å­—ï¼šã€Œé€™æ˜¯ä»€éº¼è²éŸ³ï¼Ÿã€
    â†’ Tokenizer â†’ [Token IDs]
    â†’ é›¢æ•£çš„æ•´æ•¸åºåˆ—

2ï¸âƒ£  éŸ³é »ï¼šaudio.mp3 (4ç§’çš„éŸ³é »)
    â†’ Feature Extractor â†’ [Mel-spectrogram]
    â†’ é€£çºŒçš„æµ®é»æ•¸çŸ©é™£

å•é¡Œï¼šå¦‚ä½•è®“ä¸€å€‹ Transformer æ¨¡å‹åŒæ™‚ç†è§£é€™å…©ç¨®æ•¸æ“šï¼Ÿ
    """)

    # ============================================================================
    # ç¬¬äºŒéƒ¨åˆ†ï¼šéŒ¯èª¤çš„æ–¹æ³• vs æ­£ç¢ºçš„æ–¹æ³•
    # ============================================================================
    print_header("ç¬¬äºŒéƒ¨åˆ†ï¼šèåˆæ–¹æ³•å°æ¯”")

    print_subheader("âŒ æ–¹æ³• Aï¼šç‰¹å¾µç´šæ‹¼æ¥ (Feature-Level Concatenation) - éŒ¯èª¤ï¼")

    print("""
é€™æ˜¯ä¸€å€‹ç›´è§€ä½†éŒ¯èª¤çš„æƒ³æ³•ï¼š

    æ–‡å­—ç‰¹å¾µ: [3584ç¶­å‘é‡]  â”€â”€â”
                               â”œâ”€â†’ æ‹¼æ¥ â”€â†’ [7168ç¶­å‘é‡]
    éŸ³é »ç‰¹å¾µ: [3584ç¶­å‘é‡]  â”€â”€â”˜

å•é¡Œï¼š
  1. ç¶­åº¦çˆ†ç‚¸ï¼š7168 ç¶­ vs åŸæœ¬çš„ 3584 ç¶­
  2. ç„¡æ³•è™•ç†å¯è®Šé•·åº¦ï¼šéŸ³é »é•·åº¦ä¸å›ºå®š
  3. ç ´å£äº†é è¨“ç·´çš„ Transformerï¼šæ¨¡å‹æœŸæœ› 3584 ç¶­è¼¸å…¥
  4. ç„¡æ³•è™•ç†å¤šæ®µéŸ³é »ï¼šå¦‚æœæœ‰å…©æ®µéŸ³é »æ€éº¼è¾¦ï¼Ÿ
    """)

    print_subheader("âŒ æ–¹æ³• Bï¼šç‰¹å¾µç´šç›¸åŠ  (Feature-Level Addition) - ä¹ŸéŒ¯èª¤ï¼")

    print("""
å¦ä¸€å€‹æƒ³æ³•ï¼šæŠŠå…©å€‹ç‰¹å¾µç›¸åŠ 

    æ–‡å­—ç‰¹å¾µ: [3584ç¶­å‘é‡]  â”€â”€â”
                               â”œâ”€â†’ ç›¸åŠ  â”€â†’ [3584ç¶­å‘é‡]
    éŸ³é »ç‰¹å¾µ: [3584ç¶­å‘é‡]  â”€â”€â”˜

å•é¡Œï¼š
  1. ä¿¡æ¯æ··æ·†ï¼šæ–‡å­—å’ŒéŸ³é »çš„ä¿¡æ¯æ··åœ¨ä¸€èµ·ï¼Œç„¡æ³•å€åˆ†
  2. é•·åº¦å•é¡Œï¼šéŸ³é »å¯èƒ½æœ‰187å€‹æ™‚é–“æ­¥ï¼Œæ–‡å­—åªæœ‰32å€‹ token
  3. èªç¾©ç ´å£ï¼šã€Œä»€éº¼ã€é€™å€‹è©çš„ embedding + éŸ³é »æŸä¸€å¹€ = ï¼Ÿï¼Ÿï¼Ÿ
    """)

    print_subheader("âœ… æ–¹æ³• Cï¼šåºåˆ—ç´šæ’å…¥ (Sequence-Level Insertion) - æ­£ç¢ºï¼")

    print("""
Qwen2-Audio çš„æ­£ç¢ºåšæ³•ï¼š

æŠŠéŸ³é » embeddings ç•¶ä½œä¸€ç³»åˆ—çš„ "token"ï¼Œæ’å…¥åˆ°æ–‡å­—åºåˆ—ä¸­ï¼

é—œéµæ¦‚å¿µï¼š
  â€¢ ä¸æ”¹è®Š embedding ç¶­åº¦ï¼ˆä¿æŒ 3584 æˆ– 4096 ç¶­ï¼‰
  â€¢ æ”¹è®Šåºåˆ—é•·åº¦ï¼ˆå¢åŠ éŸ³é »çš„æ™‚é–“æ­¥æ•¸ï¼‰
  â€¢ ä½¿ç”¨ç‰¹æ®Š token <|AUDIO|> ä½œç‚º"éŒ¨é»"æ¨™è¨˜æ’å…¥ä½ç½®
  â€¢ è®“ Transformer çš„ Self-Attention è™•ç†èåˆ
    """)

    # ============================================================================
    # ç¬¬ä¸‰éƒ¨åˆ†ï¼šè©³ç´°çš„åºåˆ—æ’å…¥éç¨‹
    # ============================================================================
    print_header("ç¬¬ä¸‰éƒ¨åˆ†ï¼šåºåˆ—æ’å…¥çš„è©³ç´°éç¨‹")

    print_subheader("æ­¥é©Ÿ 1ï¼šæ§‹å»ºå¸¶æœ‰ç‰¹æ®Š token çš„æ–‡å­—åºåˆ—")

    print("""
ç”¨æˆ¶è¼¸å…¥ï¼š
  æ–‡å­—: "é€™æ˜¯ä»€éº¼è²éŸ³ï¼Ÿ"
  éŸ³é »: glass-breaking.mp3

æ§‹å»ºæç¤ºè©æ™‚ï¼Œæ’å…¥ç‰¹æ®Šçš„éŸ³é »æ¨™è¨˜ï¼š

  "<|audio_bos|><|AUDIO|><|audio_eos|>é€™æ˜¯ä»€éº¼è²éŸ³ï¼Ÿ"

Tokenization å¾Œçš„åºåˆ—ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰ï¼š

  ä½ç½®:  0    1    2    3    4      5      6       7       8      9     10
  Token: <s> <im> ... <ab> <AUD> <ae>   é€™    æ˜¯    ä»€éº¼   è²éŸ³    ?    </s>

  å…¶ä¸­ï¼š
  <ab> = <|audio_bos|>  (audio begin of sequence)
  <AUD> = <|AUDIO|>     (audio placeholder)
  <ae> = <|audio_eos|>  (audio end of sequence)

é—œéµè§€å¯Ÿï¼š
  â˜… <|AUDIO|> æ˜¯ä¸€å€‹ä½”ä½ç¬¦ tokenï¼
  â˜… å®ƒçš„ token ID æ˜¯ 151646
  â˜… å®ƒæœƒåœ¨æ¨¡å‹å…§éƒ¨è¢«æ›¿æ›æˆå¯¦éš›çš„éŸ³é » embeddings
    """)

    print_subheader("æ­¥é©Ÿ 2ï¼šToken Embedding - æ–‡å­—è®Šæˆå‘é‡")

    print("""
æ¯å€‹ token ID é€šé embedding å±¤è½‰æ›æˆé«˜ç¶­å‘é‡ï¼š

  Token ID â†’ Embedding Lookup Table â†’ Embedding Vector (4096ç¶­)

ç¤ºæ„åœ–ï¼š

  ä½ç½® 0:  <s>    â†’ [0.12, -0.34, 0.56, ..., 0.78]  (4096å€‹æ•¸å­—)
  ä½ç½® 1:  <im>   â†’ [0.23, 0.45, -0.67, ..., -0.12]
  ä½ç½® 2:  ...
  ä½ç½® 3:  <ab>   â†’ [0.34, -0.56, 0.78, ..., 0.90]
  ä½ç½® 4:  <AUD>  â†’ [0.45, 0.67, -0.89, ..., 0.23]  â† é€™å€‹æœƒè¢«æ›¿æ›ï¼
  ä½ç½® 5:  <ae>   â†’ [0.56, -0.78, 0.90, ..., -0.34]
  ä½ç½® 6:  é€™     â†’ [0.67, 0.89, -0.12, ..., 0.45]
  ä½ç½® 7:  æ˜¯     â†’ [0.78, -0.90, 0.34, ..., -0.56]
  ...

æ­¤æ™‚çš„å½¢ç‹€ï¼š[batch_size=1, seq_len=11, hidden_dim=4096]
å³ï¼š[1, 11, 4096]
    """)

    print_subheader("æ­¥é©Ÿ 3ï¼šAudio Encoding - éŸ³é »è®Šæˆå‘é‡åºåˆ—")

    print("""
åŒæ™‚ï¼ŒéŸ³é »é€šéå®Œå…¨ç¨ç«‹çš„è™•ç†ç®¡é“ï¼š

  éŸ³é »æ³¢å½¢ (64512å€‹æ¨£æœ¬ï¼Œ4.03ç§’)
    â†“
  Mel-spectrogram [1, 128, 3000]
  (128å€‹é »ç‡é€šé“ Ã— 3000å€‹æ™‚é–“å¹€)
    â†“
  Audio Encoder (Whisper-based Transformer)
    â†“
  Audio Embeddings [1, 187, 4096]
  (187å€‹æ™‚é–“æ­¥ Ã— 4096ç¶­)

æ³¨æ„ï¼š
  â€¢ 3000å€‹æ™‚é–“å¹€è¢«ä¸‹æ¡æ¨£åˆ° 187 å€‹ embeddings
  â€¢ æ¯å€‹ embedding ä¹Ÿæ˜¯ 4096 ç¶­ï¼ˆå’Œæ–‡å­— embedding ç›¸åŒï¼ï¼‰
  â€¢ é€™ 187 å€‹å‘é‡ä»£è¡¨éŸ³é »åœ¨ä¸åŒæ™‚é–“çš„èªç¾©ä¿¡æ¯

å¯ä»¥æƒ³åƒæˆï¼š
  Audio_Emb_1:  [0.11, -0.22, 0.33, ..., 0.44]  (4096ç¶­) â† ä»£è¡¨ç¬¬ 0-21ms
  Audio_Emb_2:  [0.22, 0.33, -0.44, ..., -0.55]  (4096ç¶­) â† ä»£è¡¨ç¬¬ 21-42ms
  Audio_Emb_3:  [0.33, -0.44, 0.55, ..., 0.66]  (4096ç¶­) â† ä»£è¡¨ç¬¬ 42-63ms
  ...
  Audio_Emb_187: [0.88, -0.99, 0.11, ..., -0.22] (4096ç¶­) â† ä»£è¡¨æœ€å¾Œ 21ms
    """)

    print_subheader("æ­¥é©Ÿ 4ï¼šåºåˆ—æ’å…¥ - é—œéµçš„èåˆæ­¥é©Ÿï¼")

    print("""
ç¾åœ¨æ˜¯é—œéµçš„ä¸€æ­¥ï¼š

1. æ‰¾åˆ° <|AUDIO|> token åœ¨åºåˆ—ä¸­çš„ä½ç½®ï¼ˆä½ç½® 4ï¼‰

2. å°‡è©²ä½ç½®çš„ embedding æ›¿æ›æˆ 187 å€‹éŸ³é » embeddings

æ›¿æ›å‰çš„åºåˆ—ï¼ˆ11 å€‹ä½ç½®ï¼‰ï¼š
â•”â•â•â•â•â•¦â•â•â•â•â•¦â•â•â•â•¦â•â•â•â•â•¦â•â•â•â•â•â•â•¦â•â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•â•—
â•‘ 0  â•‘ 1  â•‘ 2 â•‘ 3  â•‘  4   â•‘ 5  â•‘ 6 â•‘ 7 â•‘ 8 â•‘ 9 â•‘ 10 â•‘
â•‘<s> â•‘<im>â•‘...â•‘<ab>â•‘<AUD> â•‘<ae>â•‘é€™ â•‘æ˜¯ â•‘ä»€éº¼â•‘è²éŸ³â•‘ ?  â•‘
â•šâ•â•â•â•â•©â•â•â•â•â•©â•â•â•â•©â•â•â•â•â•©â•â•â•â•â•â•â•©â•â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•â•
                      â†‘
                    é€™å€‹ä½ç½®æœƒè¢«æ›¿æ›ï¼

æ›¿æ›å¾Œçš„åºåˆ—ï¼ˆ11 - 1 + 187 = 197 å€‹ä½ç½®ï¼‰ï¼š
â•”â•â•â•â•â•¦â•â•â•â•â•¦â•â•â•â•¦â•â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•â•â•â•â•¦â•â•â•â•¦â•â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•¦â•â•â•â•â•—
â•‘ 0  â•‘ 1  â•‘ 2 â•‘ 3  â•‘ 4 â•‘ 5 â•‘ 6 â•‘  ...  â•‘189â•‘190 â•‘191â•‘192â•‘193â•‘194â•‘195 â•‘
â•‘<s> â•‘<im>â•‘...â•‘<ab>â•‘A_1â•‘A_2â•‘A_3â•‘ A_... â•‘187â•‘<ae>â•‘é€™ â•‘æ˜¯ â•‘ä»€éº¼â•‘è²éŸ³â•‘ ?  â•‘
â•šâ•â•â•â•â•©â•â•â•â•â•©â•â•â•â•©â•â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•â•â•â•â•©â•â•â•â•©â•â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•©â•â•â•â•â•
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      187 å€‹éŸ³é » embeddings

é—œéµé»ï¼š
  âœ“ åŸæœ¬ 1 å€‹ <|AUDIO|> token â†’ ç¾åœ¨è®Šæˆ 187 å€‹éŸ³é » embeddings
  âœ“ åºåˆ—é•·åº¦å¾ 11 è®Šæˆ 197
  âœ“ æ¯å€‹ä½ç½®ä»ç„¶æ˜¯ 4096 ç¶­å‘é‡
  âœ“ æ–‡å­—å’ŒéŸ³é »åœ¨åŒä¸€å€‹åºåˆ—ä¸­ï¼Œä½†åœ¨ä¸åŒçš„ä½ç½®
  âœ“ å½¢ç‹€ï¼š[1, 11, 4096] â†’ [1, 197, 4096]
    """)

    print_subheader("æ­¥é©Ÿ 5ï¼šå¯è¦–åŒ–å¼µé‡å½¢ç‹€è®ŠåŒ–")

    print("""
è®“æˆ‘å€‘ç”¨å…·é«”çš„ç¶­åº¦ä¾†çœ‹é€™å€‹è®ŠåŒ–ï¼š

éšæ®µ 1ï¼šæ–‡å­— Tokenization
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Token IDs              â”‚
  â”‚  [1, 11]                â”‚
  â”‚  (11 å€‹ token)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éšæ®µ 2ï¼šToken Embedding
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Text Embeddings        â”‚
  â”‚  [1, 11, 4096]          â”‚
  â”‚  (11å€‹ä½ç½®Ã—4096ç¶­)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éšæ®µ 3ï¼šAudio Encoding (å¹³è¡Œè™•ç†)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Audio Embeddings       â”‚
  â”‚  [1, 187, 4096]         â”‚
  â”‚  (187å€‹æ™‚é–“æ­¥Ã—4096ç¶­)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éšæ®µ 4ï¼šåºåˆ—æ’å…¥
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Text Embeddings        â”‚        â”‚  Audio Embeddings       â”‚
  â”‚  [1, 11, 4096]          â”‚   +    â”‚  [1, 187, 4096]         â”‚
  â”‚                         â”‚        â”‚                         â”‚
  â”‚  åœ¨ä½ç½®4æ’å…¥éŸ³é »       â”‚        â”‚  æ›¿æ›æ‰<|AUDIO|>        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Fused Sequence                                             â”‚
  â”‚  [1, 197, 4096]                                             â”‚
  â”‚                                                             â”‚
  â”‚  = 10å€‹æ–‡å­—token + 187å€‹éŸ³é »embeddings + å…¶ä»–token         â”‚
  â”‚  = 11 - 1 (è¢«æ›¿æ›çš„<|AUDIO|>) + 187                       â”‚
  â”‚  = 197                                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—œéµè§€å¯Ÿï¼š
  â€¢ ç¬¬ä¸€ç¶­ (batch_size=1) ä¸è®Š
  â€¢ ç¬¬äºŒç¶­ (seq_len) å¾ 11 â†’ 197 (å¢åŠ äº† 186)
  â€¢ ç¬¬ä¸‰ç¶­ (hidden_dim=4096) ä¸è®Š â† é€™æ˜¯é—œéµï¼
    """)

    # ============================================================================
    # ç¬¬å››éƒ¨åˆ†ï¼šèˆ‡å…¶ä»–æ–¹æ³•çš„å°æ¯”
    # ============================================================================
    print_header("ç¬¬å››éƒ¨åˆ†ï¼šç‚ºä»€éº¼åºåˆ—ç´šæ’å…¥å„ªæ–¼å…¶ä»–æ–¹æ³•ï¼Ÿ")

    print("""
è®“æˆ‘å€‘å°æ¯”ä¸‰ç¨®æ–¹æ³•çš„å¯¦éš›æ•ˆæœï¼š

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      æ–¹æ³•            â•‘   ç¶­åº¦è®ŠåŒ–        â•‘   ä¿¡æ¯ä¿ç•™        â•‘   éˆæ´»æ€§         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç‰¹å¾µæ‹¼æ¥             â•‘ [11, 4096]        â•‘ ä¿¡æ¯æ··åœ¨ä¸€èµ·      â•‘ ç„¡æ³•è™•ç†å¤šéŸ³é »   â•‘
â•‘ (Concatenation)      â•‘    â†“              â•‘ ç„¡æ³•å€åˆ†ä¾†æº      â•‘ ç„¡æ³•è®Šé•·åºåˆ—     â•‘
â•‘                      â•‘ [11, 8192]        â•‘                   â•‘                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç‰¹å¾µç›¸åŠ              â•‘ [11, 4096]        â•‘ ä¿¡æ¯åš´é‡æ··æ·†      â•‘ é•·åº¦ä¸åŒ¹é…å•é¡Œ   â•‘
â•‘ (Addition)           â•‘    â†“              â•‘ èªç¾©è¢«ç ´å£        â•‘ 187 vs 11?       â•‘
â•‘                      â•‘ [11, 4096]        â•‘                   â•‘                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ åºåˆ—æ’å…¥ âœ“           â•‘ [11, 4096]        â•‘ ä¿¡æ¯å®Œæ•´ä¿ç•™      â•‘ å®Œå…¨éˆæ´»         â•‘
â•‘ (Sequence Insertion) â•‘    â†“              â•‘ ä¾†æºæ¸…æ™°å¯è¾¨      â•‘ æ”¯æŒå¤šéŸ³é »       â•‘
â•‘                      â•‘ [197, 4096]       â•‘ ä½ç½®é—œä¿‚æ˜ç¢º      â•‘ æ”¯æŒè®Šé•·         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åºåˆ—æ’å…¥çš„å„ªå‹¢ï¼š

1ï¸âƒ£  ä¿æŒ Embedding ç¶­åº¦
    âœ“ 4096 ç¶­ä¸è®Šï¼Œå…¼å®¹é è¨“ç·´çš„ Transformer
    âœ“ ä¸éœ€è¦ä¿®æ”¹æ¨¡å‹æ¶æ§‹

2ï¸âƒ£  æ¸…æ™°çš„ä½ç½®ä¿¡æ¯
    âœ“ ä½ç½® 0-3: ç³»çµ±æç¤º
    âœ“ ä½ç½® 4-190: éŸ³é »å…§å®¹
    âœ“ ä½ç½® 191-196: å•é¡Œæ–‡å­—

3ï¸âƒ£  éˆæ´»çš„èåˆèƒ½åŠ›
    âœ“ å¯ä»¥æ’å…¥å¤šæ®µéŸ³é »ï¼š<|AUDIO|> ... <|AUDIO|> ... <|AUDIO|>
    âœ“ å¯ä»¥è™•ç†ä¸åŒé•·åº¦çš„éŸ³é »
    âœ“ å¯ä»¥åœ¨ä»»æ„ä½ç½®æ’å…¥

4ï¸âƒ£  è‡ªç„¶çš„ Attention æ©Ÿåˆ¶
    âœ“ "ä»€éº¼è²éŸ³" çš„ token å¯ä»¥ attend åˆ°éŸ³é » embeddings
    âœ“ éŸ³é » embeddings å¯ä»¥äº’ç›¸ attend (æ•æ‰æ™‚åºé—œä¿‚)
    âœ“ Transformer è‡ªå‹•å­¸ç¿’è·¨æ¨¡æ…‹çš„é—œè¯
    """)

    # ============================================================================
    # ç¬¬äº”éƒ¨åˆ†ï¼šAttention å¦‚ä½•è™•ç†èåˆå¾Œçš„åºåˆ—
    # ============================================================================
    print_header("ç¬¬äº”éƒ¨åˆ†ï¼šTransformer Attention å¦‚ä½•è™•ç†èåˆåºåˆ—")

    print("""
ç¾åœ¨åºåˆ—æ˜¯ï¼š[<s>, <im>, ..., <ab>, Audio_1, Audio_2, ..., Audio_187, <ae>, é€™, æ˜¯, ä»€éº¼, è²éŸ³, ?]

åœ¨ Self-Attention ä¸­ï¼Œæ¯å€‹ä½ç½®éƒ½å¯ä»¥ attend åˆ°å…¶ä»–æ‰€æœ‰ä½ç½®ï¼š

ä½ç½® 193 ("ä»€éº¼") çš„ Attention åˆ†æ•¸å¯èƒ½æ˜¯ï¼š

    ä½ç½®     Token/Emb      Attention Score     æ„ç¾©
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0        <s>            0.01               é–‹å§‹ç¬¦è™Ÿï¼Œä¸é‡è¦
    1        <im>           0.02               æç¤ºæ¨™è¨˜
    ...      ...            ...
    4        Audio_1        0.15 â˜…            éŸ³é »é–‹é ­ï¼Œå¯èƒ½æœ‰é—œ
    5        Audio_2        0.12
    ...      ...            ...
    95       Audio_92       0.35 â˜…â˜…          ç»ç’ƒç ´ç¢çš„é—œéµæ™‚åˆ»ï¼
    96       Audio_93       0.28 â˜…â˜…          è²éŸ³æœ€éŸ¿çš„éƒ¨åˆ†
    ...      ...            ...
    190      Audio_187      0.08              éŸ³é »çµå°¾
    191      é€™             0.18 â˜…            å•é¡Œçš„ä¸€éƒ¨åˆ†
    192      æ˜¯             0.12
    193      ä»€éº¼           1.00 â˜…â˜…â˜…        è‡ªå·±ï¼ˆç¸½æ˜¯æœ€é«˜ï¼‰
    194      è²éŸ³           0.42 â˜…â˜…          é—œéµè©ï¼
    195      ?              0.15

è§€å¯Ÿï¼š
  â€¢ "ä»€éº¼" é€™å€‹ token æœ€ attend åˆ°è‡ªå·±ï¼ˆ1.00ï¼‰
  â€¢ å…¶æ¬¡æ˜¯ "è²éŸ³"ï¼ˆ0.42ï¼‰- å› ç‚ºå®ƒå€‘èªç¾©ç›¸é—œ
  â€¢ ä¹Ÿæœƒ attend åˆ°éŸ³é »çš„é—œéµæ™‚åˆ»ï¼ˆ0.35, 0.28ï¼‰
  â€¢ é€™å°±æ˜¯è·¨æ¨¡æ…‹ç†è§£ï¼

é¡ä¼¼åœ°ï¼ŒAudio_92 çš„ Attention åˆ†æ•¸å¯èƒ½æ˜¯ï¼š

    ä½ç½®     Token/Emb      Attention Score     æ„ç¾©
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ...      ...            ...
    91       Audio_91       0.45 â˜…â˜…          å‰ä¸€æ™‚åˆ»ï¼ˆæ™‚åºé€£è²«ï¼‰
    92       Audio_92       1.00 â˜…â˜…â˜…        è‡ªå·±
    93       Audio_93       0.38 â˜…â˜…          å¾Œä¸€æ™‚åˆ»ï¼ˆæ™‚åºé€£è²«ï¼‰
    94       Audio_94       0.25 â˜…
    ...      ...            ...
    193      ä»€éº¼           0.08              æ³¨æ„åˆ°å•é¡Œè©
    194      è²éŸ³           0.15 â˜…           ç†è§£å•é¡Œæ˜¯é—œæ–¼è²éŸ³
    195      ?              0.05

è§€å¯Ÿï¼š
  â€¢ éŸ³é » embeddings ä¸»è¦ attend åˆ°é™„è¿‘çš„éŸ³é »æ™‚é–“æ­¥ï¼ˆæ™‚åºå»ºæ¨¡ï¼‰
  â€¢ ä¹Ÿæœƒ attend åˆ°é—œéµè©å¦‚ "è²éŸ³"
  â€¢ å½¢æˆäº†éŸ³é »å…§éƒ¨çš„æ™‚åºç†è§£ + è·¨æ¨¡æ…‹çš„èªç¾©ç†è§£

é€™å°±æ˜¯ç‚ºä»€éº¼æ¨¡å‹èƒ½å¤ ï¼š
  âœ“ ç†è§£éŸ³é »å…§å®¹ï¼ˆé€šééŸ³é » embeddings ä¹‹é–“çš„ attentionï¼‰
  âœ“ ç†è§£å•é¡Œï¼ˆé€šéæ–‡å­— tokens ä¹‹é–“çš„ attentionï¼‰
  âœ“ å°‡å…©è€…è¯ç¹«èµ·ä¾†ï¼ˆé€šéè·¨æ¨¡æ…‹çš„ attentionï¼‰
    """)

    # ============================================================================
    # ç¬¬å…­éƒ¨åˆ†ï¼šå¯¦éš›ä»£ç¢¼ä¸­çš„å¯¦ç¾
    # ============================================================================
    print_header("ç¬¬å…­éƒ¨åˆ†ï¼šå¯¦éš›ä»£ç¢¼ä¸­å¦‚ä½•å¯¦ç¾")

    print("""
åœ¨ Transformers åº«ä¸­ï¼Œé€™å€‹éç¨‹æ˜¯é€™æ¨£å¯¦ç¾çš„ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰ï¼š

```python
# æ­¥é©Ÿ 1: æº–å‚™è¼¸å…¥
text_with_audio_marker = "<|audio_bos|><|AUDIO|><|audio_eos|>é€™æ˜¯ä»€éº¼è²éŸ³ï¼Ÿ"
audio_waveform = load_audio("glass-breaking.mp3")

# æ­¥é©Ÿ 2: åˆ†åˆ¥è™•ç†
text_tokens = tokenizer(text_with_audio_marker)  # [1, 11]
audio_features = feature_extractor(audio_waveform)  # [1, 128, 3000]

# æ­¥é©Ÿ 3: åœ¨æ¨¡å‹å…§éƒ¨
class Qwen2AudioModel:
    def forward(self, input_ids, audio_features):
        # 3.1 Token embedding
        text_embeds = self.embed_tokens(input_ids)  # [1, 11, 4096]

        # 3.2 Audio encoding
        audio_embeds = self.audio_encoder(audio_features)  # [1, 187, 4096]

        # 3.3 æ‰¾åˆ° <|AUDIO|> token çš„ä½ç½®
        audio_token_id = 151646
        audio_positions = (input_ids == audio_token_id)  # ä½ç½® 4 æ˜¯ True

        # 3.4 åºåˆ—æ’å…¥ï¼ˆé—œéµæ­¥é©Ÿï¼ï¼‰
        fused_embeds = []
        audio_idx = 0
        for i, token_id in enumerate(input_ids[0]):
            if token_id == audio_token_id:
                # æ’å…¥éŸ³é » embeddings
                fused_embeds.append(audio_embeds[audio_idx])
                audio_idx += 1
            else:
                # ä¿ç•™æ–‡å­— embedding
                fused_embeds.append(text_embeds[:, i:i+1, :])

        fused_embeds = torch.cat(fused_embeds, dim=1)  # [1, 197, 4096]

        # 3.5 é€²å…¥ Transformer
        output = self.transformer(fused_embeds)

        return output
```

é—œéµä»£ç¢¼å°±æ˜¯æ­¥é©Ÿ 3.4 çš„å¾ªç’°ï¼š
  â€¢ éæ­·æ¯å€‹ token
  â€¢ å¦‚æœæ˜¯æ™®é€š token â†’ ä¿ç•™å…¶ embedding
  â€¢ å¦‚æœæ˜¯ <|AUDIO|> â†’ æ›¿æ›æˆæ•´å€‹éŸ³é » embeddings åºåˆ—
    """)

    # ============================================================================
    # ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå¤šéŸ³é »çš„æƒ…æ³
    # ============================================================================
    print_header("ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå¦‚æœæœ‰å¤šæ®µéŸ³é »æ€éº¼è¾¦ï¼Ÿ")

    print("""
åºåˆ—æ’å…¥çš„æ–¹æ³•å¤©ç„¶æ”¯æŒå¤šæ®µéŸ³é »ï¼

ä¾‹å¦‚ï¼Œæç¤ºè©æ˜¯ï¼š
  "æ¯”è¼ƒé€™å…©å€‹è²éŸ³ï¼š<|audio_bos|><|AUDIO|><|audio_eos|> å’Œ <|audio_bos|><|AUDIO|><|audio_eos|>"

Token åºåˆ—ï¼š
  [æ¯”è¼ƒ, é€™, å…©å€‹, è²éŸ³, <ab>, <AUD>, <ae>, å’Œ, <ab>, <AUD>, <ae>]
                                  â†‘                      â†‘
                              ç¬¬ä¸€å€‹éŸ³é »              ç¬¬äºŒå€‹éŸ³é »

æ’å…¥å¾Œï¼š
  [æ¯”è¼ƒ, é€™, å…©å€‹, è²éŸ³, <ab>,
   Audio1_1, Audio1_2, ..., Audio1_187,  â† ç¬¬ä¸€æ®µéŸ³é »çš„ 187 å€‹ embeddings
   <ae>, å’Œ, <ab>,
   Audio2_1, Audio2_2, ..., Audio2_187,  â† ç¬¬äºŒæ®µéŸ³é »çš„ 187 å€‹ embeddings
   <ae>]

åºåˆ—é•·åº¦ï¼š11 - 2 + 187*2 = 383

æ¨¡å‹å¯ä»¥ï¼š
  âœ“ ç†è§£ç¬¬ä¸€æ®µéŸ³é »çš„å…§å®¹
  âœ“ ç†è§£ç¬¬äºŒæ®µéŸ³é »çš„å…§å®¹
  âœ“ æ¯”è¼ƒå…©è€…çš„ç•°åŒ
  âœ“ ç†è§£ "æ¯”è¼ƒ" å’Œ "å’Œ" ç­‰é€£æ¥è©
    """)

    # ============================================================================
    # ç¸½çµ
    # ============================================================================
    print_header("ç¸½çµï¼šåºåˆ—ç´šæ’å…¥çš„æ ¸å¿ƒè¦é»")

    print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ¯ æ ¸å¿ƒè¦é»                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  ä»€éº¼æ˜¯åºåˆ—ç´šæ’å…¥ï¼Ÿ
    æŠŠéŸ³é » embeddings ç•¶ä½œä¸€ç³»åˆ—çš„ "token"ï¼Œæ’å…¥åˆ°æ–‡å­—åºåˆ—ä¸­ï¼Œ
    è€Œä¸æ˜¯åœ¨ç‰¹å¾µç¶­åº¦ä¸Šé€²è¡Œæ‹¼æ¥æˆ–ç›¸åŠ ã€‚

2ï¸âƒ£  ç‚ºä»€éº¼å« "æ›¿æ›"ï¼Ÿ
    <|AUDIO|> æ˜¯ä¸€å€‹ä½”ä½ç¬¦ tokenï¼Œåœ¨æ¨¡å‹å…§éƒ¨æœƒè¢«æ•´å€‹éŸ³é » embeddings
    åºåˆ—æ›¿æ›æ‰ã€‚å°±åƒä½”ä½ç¬¦è¢«å±•é–‹ä¸€æ¨£ã€‚

3ï¸âƒ£  ç‚ºä»€éº¼æ˜¯åºåˆ— "ç´š"ï¼Ÿ
    å› ç‚ºæ“ä½œç™¼ç”Ÿåœ¨åºåˆ—çš„ç¶­åº¦ï¼ˆç¬¬äºŒç¶­ï¼‰ï¼Œè€Œä¸æ˜¯ç‰¹å¾µçš„ç¶­åº¦ï¼ˆç¬¬ä¸‰ç¶­ï¼‰ï¼š
    â€¢ åºåˆ—é•·åº¦æ”¹è®Šï¼š11 â†’ 197
    â€¢ ç‰¹å¾µç¶­åº¦ä¸è®Šï¼š4096 â†’ 4096

4ï¸âƒ£  é—œéµçš„å½¢ç‹€è®ŠåŒ–
    [1, 11, 4096]  â†’ (æ’å…¥) â†’  [1, 197, 4096]
     â†‘   â†‘   â†‘                    â†‘   â†‘    â†‘
     |   |   |                    |   |    |
    batch seq hidden             batch seq hidden
          é•·åº¦                         é•·åº¦
          è®Šäº†ï¼                        å¢åŠ äº†

5ï¸âƒ£  ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆæœ‰æ•ˆï¼Ÿ
    â€¢ ä¿æŒé è¨“ç·´æ¨¡å‹æ¶æ§‹ä¸è®Š
    â€¢ Transformer çš„ Self-Attention å¤©ç„¶æ”¯æŒè®Šé•·åºåˆ—
    â€¢ æ¸…æ™°çš„ä½ç½®ä¿¡æ¯ï¼Œä¾¿æ–¼è·¨æ¨¡æ…‹ç†è§£
    â€¢ éˆæ´»æ”¯æŒå¤šéŸ³é »ã€è®Šé•·éŸ³é »

6ï¸âƒ£  é¡æ¯”ç†è§£
    å°±åƒåœ¨ä¸€æ®µè©±ä¸­æ’å…¥åœ–ç‰‡ï¼š
    "é€™æ˜¯ä¸€å¼µåœ–ç‰‡ [IMAGE_PLACEHOLDER] ä½ çœ‹åˆ°äº†ä»€éº¼ï¼Ÿ"

    è™•ç†æ™‚æŠŠ [IMAGE_PLACEHOLDER] å±•é–‹æˆå¤šå€‹ "åœ–ç‰‡ token"ï¼š
    "é€™æ˜¯ä¸€å¼µåœ–ç‰‡ [IMG_1] [IMG_2] ... [IMG_N] ä½ çœ‹åˆ°äº†ä»€éº¼ï¼Ÿ"

    åªæ˜¯é€™è£¡çš„ "åœ–ç‰‡ token" æ˜¯éŸ³é » embeddingsï¼

7ï¸âƒ£  èˆ‡å…¶ä»–å¤šæ¨¡æ…‹æ¨¡å‹çš„å°æ¯”
    â€¢ LLaVA (è¦–è¦º): ä¹Ÿä½¿ç”¨åºåˆ—æ’å…¥ï¼Œåœ¨ <image> ä½ç½®æ’å…¥è¦–è¦ºç‰¹å¾µ
    â€¢ Flamingo: ä½¿ç”¨äº¤å‰æ³¨æ„åŠ›ï¼ˆæ›´è¤‡é›œï¼‰
    â€¢ BLIP-2: ä½¿ç”¨ Q-Formerï¼ˆä¸­é–“å±¤ï¼‰
    â€¢ Qwen2-Audio: ç°¡å–®ç›´æ¥çš„åºåˆ—æ’å…¥ï¼ˆproven to work!ï¼‰
    """)

def demonstrate_with_actual_model():
    """ç”¨å¯¦éš›æ¨¡å‹å±•ç¤ºåºåˆ—æ’å…¥"""

    print_header("å¯¦éš›æ¨¡å‹æ¼”ç¤ºï¼šè¿½è¹¤åºåˆ—é•·åº¦è®ŠåŒ–")

    print("\nè¼‰å…¥ processor...")
    processor = AutoProcessor.from_pretrained("Qwen/Qwen2-Audio-7B-Instruct")

    # å‰µå»ºä¸€å€‹åŒ…å«éŸ³é »æ¨™è¨˜çš„æ–‡å­—
    text = "<|audio_bos|><|AUDIO|><|audio_eos|>é€™æ˜¯ä»€éº¼è²éŸ³ï¼Ÿ"

    print(f"\nè¼¸å…¥æ–‡å­—: {text}")

    # Tokenize
    tokens = processor.tokenizer(text, return_tensors="pt")
    token_ids = tokens.input_ids[0].tolist()

    print(f"\nToken IDs: {token_ids}")
    print(f"åºåˆ—é•·åº¦: {len(token_ids)}")

    # æ‰¾å‡ºç‰¹æ®Š token
    audio_bos_id = processor.tokenizer.convert_tokens_to_ids("<|audio_bos|>")
    audio_id = processor.tokenizer.convert_tokens_to_ids("<|AUDIO|>")
    audio_eos_id = processor.tokenizer.convert_tokens_to_ids("<|audio_eos|>")

    print(f"\nç‰¹æ®Š Token IDs:")
    print(f"  <|audio_bos|> = {audio_bos_id}")
    print(f"  <|AUDIO|>     = {audio_id}")
    print(f"  <|audio_eos|> = {audio_eos_id}")

    # é¡¯ç¤ºæ¯å€‹ä½ç½®çš„ token
    print(f"\nè©³ç´°çš„ Token åºåˆ—:")
    print(f"{'ä½ç½®':<6} {'Token ID':<10} {'Token':<20} {'èªªæ˜'}")
    print("â”€" * 70)

    for i, tid in enumerate(token_ids):
        token_str = processor.tokenizer.convert_ids_to_tokens([tid])[0]

        if tid == audio_bos_id:
            note = "â† éŸ³é »é–‹å§‹æ¨™è¨˜"
        elif tid == audio_id:
            note = "â† ğŸ¯ é€™å€‹æœƒè¢«æ›¿æ›æˆ ~187 å€‹éŸ³é » embeddings!"
        elif tid == audio_eos_id:
            note = "â† éŸ³é »çµæŸæ¨™è¨˜"
        else:
            note = ""

        print(f"{i:<6} {tid:<10} {token_str:<20} {note}")

    # æ¨¡æ“¬æ’å…¥
    print(f"\n{'='*70}")
    print("æ¨¡æ“¬åºåˆ—æ’å…¥éç¨‹ï¼š")
    print(f"{'='*70}")

    audio_position = token_ids.index(audio_id)
    num_audio_embeddings = 187  # å‡è¨­ 4 ç§’éŸ³é »ç”¢ç”Ÿ 187 å€‹ embeddings

    print(f"\n1. åŸå§‹åºåˆ—é•·åº¦: {len(token_ids)}")
    print(f"2. <|AUDIO|> ä½ç½®: {audio_position}")
    print(f"3. éŸ³é » embeddings æ•¸é‡: {num_audio_embeddings}")
    print(f"4. æ’å…¥å¾Œåºåˆ—é•·åº¦: {len(token_ids) - 1 + num_audio_embeddings}")
    print(f"   è¨ˆç®—: {len(token_ids)} (åŸé•·åº¦) - 1 (ç§»é™¤<|AUDIO|>) + {num_audio_embeddings} (éŸ³é »)")

    print(f"\næ’å…¥å¾Œçš„åºåˆ—çµæ§‹:")
    print("ä½ç½® 0 åˆ° {}:     åŸå§‹æ–‡å­— tokens".format(audio_position - 1))
    print("ä½ç½® {} åˆ° {}:   éŸ³é » embeddings (æ›¿æ›äº† <|AUDIO|>)".format(
        audio_position, audio_position + num_audio_embeddings - 1))
    print("ä½ç½® {} åˆ° {}:  å‰©é¤˜æ–‡å­— tokens".format(
        audio_position + num_audio_embeddings,
        len(token_ids) - 1 + num_audio_embeddings - 1))

    # å½¢ç‹€è®ŠåŒ–
    hidden_dim = 4096
    print(f"\nå½¢ç‹€è®ŠåŒ–:")
    print(f"  Token IDs:         [{1}, {len(token_ids)}]")
    print(f"  Text Embeddings:   [{1}, {len(token_ids)}, {hidden_dim}]")
    print(f"  Audio Embeddings:  [{1}, {num_audio_embeddings}, {hidden_dim}]")
    print(f"  Fused Embeddings:  [{1}, {len(token_ids) - 1 + num_audio_embeddings}, {hidden_dim}]")

    print(f"\né—œéµè§€å¯Ÿ:")
    print(f"  âœ“ Batch size (ç¬¬ä¸€ç¶­) ä¿æŒ 1")
    print(f"  âœ“ åºåˆ—é•·åº¦ (ç¬¬äºŒç¶­) å¾ {len(token_ids)} å¢åŠ åˆ° {len(token_ids) - 1 + num_audio_embeddings}")
    print(f"  âœ“ Hidden dim (ç¬¬ä¸‰ç¶­) ä¿æŒ {hidden_dim}")
    print(f"  âœ“ é€™å°±æ˜¯åºåˆ—ç´šæ’å…¥ï¼")

if __name__ == "__main__":
    # è©³ç´°çš„æ¦‚å¿µè§£é‡‹
    visualize_sequence_insertion()

    # å¯¦éš›æ¨¡å‹æ¼”ç¤º
    demonstrate_with_actual_model()

    print("\n" + "="*100)
    print("è§£é‡‹å®Œæˆï¼å¸Œæœ›æ‚¨ç¾åœ¨å®Œå…¨ç†è§£äº†åºåˆ—ç´šæ’å…¥çš„æ¦‚å¿µã€‚")
    print("="*100)
